<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>6-Minuten-Gehtest Auswertung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f8f8f8; }
    h1 { text-align: center; }
    .input-block { margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; font-size: 16px; margin-bottom: 10px; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    #result { margin-top: 30px; font-weight: bold; font-size: 18px; }
    .warn { color: red; }
  </style>
</head>
<body>
  <h1>6-Minuten-Gehtest Auswertung</h1>

  <div class="input-block">
    <label for="distance">Distanz (Meter):</label>
    <input type="number" id="distance" min="0" required>
  </div>

  <div class="input-block">
    <label for="age">Alter (Jahre):</label>
    <input type="number" id="age" min="30" max="100" required>
  </div>

  <div class="input-block">
    <label for="height">GrÃ¶ÃŸe (cm):</label>
    <input type="number" id="height" min="140" max="200" required>
  </div>

  <button onclick="evaluate()">âœ… Normwert berechnen</button>
  <button onclick="generatePDF()">ðŸ“„ PDF erstellen</button>

  <div id="result"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const rawPercentiles = {
      150: { 30: [470, 511, 555, 592, 631], 40: [468, 509, 553, 590, 629], 50: [448, 489, 533, 570, 609], 60: [397, 439, 483, 520, 558], 70: [347, 388, 432, 469, 508], 80: [null, null, null, null, null] },
      160: { 30: [489, 530, 574, 611, 650], 40: [487, 528, 572, 609, 648], 50: [466, 508, 552, 588, 627], 60: [416, 457, 501, 538, 577], 70: [366, 407, 451, 488, 526], 80: [316, 357, 401, 438, 476] },
      170: { 30: [507, 549, 593, 629, 668], 40: [505, 546, 590, 627, 666], 50: [485, 526, 570, 607, 646], 60: [435, 476, 520, 557, 595], 70: [384, 425, 469, 506, 545], 80: [334, 375, 419, 456, 495] },
      180: { 30: [526, 567, 611, 648, 687], 40: [524, 565, 609, 646, 685], 50: [503, 545, 589, 626, 664], 60: [453, 494, 538, 575, 614], 70: [403, 444, 488, 525, 564], 80: [353, 394, 438, 475, 513] },
      190: { 30: [544, 586, 630, 667, 705], 40: [542, 584, 628, 665, 703], 50: [522, 563, 607, 644, 683], 60: [472, 513, 557, 594, 633], 70: [421, 463, 507, 544, 582], 80: [371, 413, 457, 494, 532] }
    };
    const percentiles = [10, 25, 50, 75, 90];

    function interpolate(val, x1, x2, y1, y2) {
      return y1 + (val - x1) * (y2 - y1) / (x2 - x1);
    }

    function findBounds(val, arr) {
      let lower = arr[0];
      let upper = arr[arr.length - 1];
      for (let i = 0; i < arr.length - 1; i++) {
        if (val >= arr[i] && val <= arr[i + 1]) {
          lower = arr[i];
          upper = arr[i + 1];
          break;
        }
      }
      return [lower, upper];
    }

    function evaluate() {
      const dist = parseFloat(document.getElementById('distance').value);
      const age = parseFloat(document.getElementById('age').value);
      const height = parseFloat(document.getElementById('height').value);
      const output = document.getElementById("result");

      if (isNaN(dist) || isNaN(age) || isNaN(height)) {
        output.innerHTML = "Bitte alle Felder korrekt ausfÃ¼llen.";
        return;
      }

      const ageSteps = [30, 40, 50, 60, 70];
      const heightSteps = [150, 160, 170, 180, 190];

      let [ageLow, ageHigh] = findBounds(age, ageSteps);
      let [heightLow, heightHigh] = findBounds(height, heightSteps);

      const interp = (pIdx) => {
        const a1 = rawPercentiles[heightLow]?.[ageLow]?.[pIdx] ?? null;
        const a2 = rawPercentiles[heightLow]?.[ageHigh]?.[pIdx] ?? null;
        const b1 = rawPercentiles[heightHigh]?.[ageLow]?.[pIdx] ?? null;
        const b2 = rawPercentiles[heightHigh]?.[ageHigh]?.[pIdx] ?? null;
        if ([a1, a2, b1, b2].some(v => v == null)) return null;
        const val1 = interpolate(age, ageLow, ageHigh, a1, a2);
        const val2 = interpolate(age, ageLow, ageHigh, b1, b2);
        return interpolate(height, heightLow, heightHigh, val1, val2);
      };

      let resultText = '';
      let matchedPercentile = null;

      for (let i = percentiles.length - 1; i >= 0; i--) {
        const est = interp(i);
        if (est == null) continue;
        if (dist >= est) {
          matchedPercentile = percentiles[i];
          break;
        }
      }

      if (matchedPercentile === null) {
        matchedPercentile = "<10";
      }

      resultText += `Die gemessene Distanz liegt im ${matchedPercentile}. Perzentil. `;
      resultText += `Die Leistung ist besser als ${matchedPercentile === "<10" ? "weniger als 10" : matchedPercentile}% der Vergleichsgruppe.`;

      if (age > 80) {
        resultText += `<br><span class="warn">âš  Achtung: FÃ¼r Alter >80 liegen keine Normdaten vor. Die Werte basieren auf Extrapolation.</span>`;
      }

      output.innerHTML = resultText;
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const dist = document.getElementById("distance").value;
      const age = document.getElementById("age").value;
      const height = document.getElementById("height").value;
      const text = document.getElementById("result").innerText;

      doc.setFontSize(16);
      doc.text("6-Minuten-Gehtest â€“ Auswertung", 10, 20);
      doc.setFontSize(12);
      doc.text(`Distanz: ${dist} m`, 10, 40);
      doc.text(`Alter: ${age} Jahre`, 10, 50);
      doc.text(`GrÃ¶ÃŸe: ${height} cm`, 10, 60);
      doc.text(text, 10, 80, { maxWidth: 180 });
      doc.save("6MWT_Auswertung.pdf");
    }
  </script>
</body>
</html>
